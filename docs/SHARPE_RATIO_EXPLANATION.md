# 夏普比率（Sharpe Ratio）详解

## 📊 什么是夏普比率？

**夏普比率（Sharpe Ratio）**是衡量**风险调整后收益**的经典指标，由诺贝尔经济学奖得主威廉·夏普（William Sharpe）提出。

### 核心公式

```
夏普比率 = (平均收益率 - 无风险利率) / 收益率标准差
```

在加密货币交易中（假设无风险利率为0）：

```
夏普比率 = 平均收益率 / 收益率标准差
```

### 通俗理解

**夏普比率告诉我们：每承担1个单位风险，能获得多少收益。**

- **高夏普比率**（>1）：收益高，波动小 → 优秀策略
- **低夏普比率**（0-1）：收益低，波动大 → 需要改进
- **负夏普比率**（<0）：平均收益为负 → 策略失效

## 🔍 当前实现原理

### 计算步骤

1. **提取账户净值序列**
   - 从每个周期的决策记录中提取 `TotalBalance`（账户总净值）
   - 过滤掉净值 ≤ 0 的记录

2. **计算周期收益率**
   ```
   周期收益率 = (当前净值 - 上一周期净值) / 上一周期净值
   ```
   - 例如：从 100 USDT 变为 105 USDT
   - 收益率 = (105 - 100) / 100 = 0.05 = 5%

3. **计算平均收益率**
   ```
   平均收益率 = 所有周期收益率的平均值
   ```

4. **计算收益率标准差**
   ```
   标准差 = √(方差)
   方差 = Σ(收益率 - 平均收益率)² / 周期数
   ```
   - 标准差衡量收益的波动性（风险）

5. **计算夏普比率**
   ```
   夏普比率 = 平均收益率 / 标准差
   ```

## ❓ 为什么显示 0.00？

### 可能原因

#### 1. **数据不足**
- **条件**：记录数 < 2
- **原因**：需要至少2个周期才能计算收益率
- **解决**：等待更多交易周期

#### 2. **账户净值无变化**
- **条件**：所有周期的 `TotalBalance` 完全相同
- **原因**：
  - 没有开仓交易
  - 持仓未实现盈亏没有变化
  - 所有决策都是 `wait` 或 `hold`，且没有持仓
- **结果**：
  - 所有周期收益率 = 0
  - 平均收益率 = 0
  - 标准差 = 0
  - 根据代码第724行：返回 0.0

#### 3. **收益率波动为0**
- **条件**：所有周期收益率完全相同（但不为0）
- **原因**：每个周期的收益变化完全相同
- **结果**：
  - 标准差 = 0
  - 如果平均收益 > 0：返回 999.0
  - 如果平均收益 < 0：返回 -999.0
  - 如果平均收益 = 0：返回 0.0

#### 4. **数据记录问题**
- **条件**：`TotalBalance` 字段记录不正确
- **可能原因**：
  - 账户状态快照未正确记录
  - 净值计算错误
  - 数据保存失败

## 🎯 正常情况下的夏普比率范围

### 周期级别（非年化）
- **优秀**：> 0.7
- **良好**：0.3 - 0.7
- **一般**：0 - 0.3
- **需改进**：< 0

### 年化后（参考）
- **优秀**：> 2.0
- **良好**：1.0 - 2.0
- **一般**：0.5 - 1.0
- **需改进**：< 0.5

**注意**：当前实现返回的是**周期级别**的夏普比率，不是年化的。

## 📈 改进建议

### 1. **增强诊断信息**
在返回0.00时，记录详细信息：
- 记录数量
- 净值序列
- 收益率序列
- 平均收益率
- 标准差

### 2. **处理边界情况**
- **数据不足**：显示 "数据不足（需要至少2个周期）"
- **无变化**：显示 "账户净值无变化（未交易或持仓无波动）"
- **零波动**：区分正收益、负收益、零收益

### 3. **使用对数收益率**
对于较大波动，使用对数收益率更准确：
```
对数收益率 = ln(当前净值 / 上一周期净值)
```

### 4. **年化处理**
如果需要年化，需要知道周期频率：
```
年化夏普比率 = 周期夏普比率 × √(年化周期数)
```
例如：3分钟周期，一年有 175,200 个周期（365×24×60/3）
年化系数 = √175200 ≈ 418.6

### 5. **最小周期数要求**
- 建议至少需要 **20-30个周期** 才能获得有意义的夏普比率
- 少于10个周期时，结果可能不稳定

## 🔧 代码改进方案

### 方案1：增加诊断日志
在计算失败时，记录详细原因：
```go
if len(records) < 2 {
    log.Printf("⚠️ 夏普比率计算失败：记录数不足（%d < 2）", len(records))
    return 0.0
}

if len(equities) < 2 {
    log.Printf("⚠️ 夏普比率计算失败：有效净值记录不足（%d < 2）", len(equities))
    return 0.0
}

if stdDev == 0 && meanReturn == 0 {
    log.Printf("⚠️ 夏普比率计算失败：账户净值无变化（所有周期净值相同）")
    log.Printf("   净值序列: %v", equities)
    return 0.0
}
```

### 方案2：使用对数收益率
```go
// 计算对数收益率（更准确）
for i := 1; i < len(equities); i++ {
    if equities[i-1] > 0 && equities[i] > 0 {
        logReturn := math.Log(equities[i] / equities[i-1])
        returns = append(returns, logReturn)
    }
}
```

### 方案3：增加最小周期数检查
```go
const MinPeriodsForSharpe = 20 // 至少需要20个周期

if len(returns) < MinPeriodsForSharpe {
    log.Printf("⚠️ 夏普比率计算：周期数不足（%d < %d），结果可能不稳定", 
        len(returns), MinPeriodsForSharpe)
    // 仍然计算，但标记为不稳定
}
```

### 方案4：返回详细状态
```go
type SharpeRatioResult struct {
    Value      float64
    Status     string // "valid", "insufficient_data", "no_variance", "unstable"
    Message    string
    Periods    int
    MeanReturn float64
    StdDev     float64
}
```

## 📝 总结

**当前显示 0.00 最可能的原因**：
1. ✅ **账户净值无变化**（最常见）
   - 没有开仓交易
   - 所有决策都是 `wait`
   - 持仓未实现盈亏没有变化

2. ✅ **数据不足**
   - 交易周期数 < 2
   - 有效净值记录 < 2

3. ✅ **数据记录问题**
   - 净值字段未正确记录
   - 账户状态快照失败

**建议改进**：
- 增加诊断日志，明确显示失败原因
- 使用对数收益率提高准确性
- 增加最小周期数要求
- 返回详细状态信息

---

## 参考资料

1. **Sharpe Ratio 原始论文**：
   - Sharpe, W. F. (1966). Mutual fund performance. Journal of business, 39(1), 119-138.

2. **计算公式**：
   - https://www.investopedia.com/terms/s/sharperatio.asp

3. **加密货币应用**：
   - 在加密货币交易中，通常假设无风险利率为0
   - 周期级别的夏普比率范围通常在 -2 到 +2 之间




