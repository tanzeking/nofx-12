# OKX API 错误诊断指南

## 错误代码 1: "All operations failed"

### 错误信息
```
OKX API错误: 1 - All operations failed
```

### 可能原因

#### 1. **账户余额不足**（最常见）
- **症状**：可用余额 < 所需保证金
- **所需保证金** = 仓位价值 / 杠杆
- **检查方法**：查看日志中的账户余额和所需保证金对比
- **解决方案**：
  - 增加账户余额
  - 降低杠杆倍数
  - 减少仓位价值（position_size_usd）

#### 2. **止损/止盈价格设置不合理**
- **做多时**：止损价必须 > 爆仓价
  - 爆仓价 = 入场价 × (1 - 1/杠杆)
  - 如果止损价 ≤ 爆仓价，止损单可能失效导致直接爆仓
- **做空时**：止损价必须 < 爆仓价
  - 爆仓价 = 入场价 × (1 + 1/杠杆)
  - 如果止损价 ≥ 爆仓价，止损单可能失效导致直接爆仓
- **解决方案**：
  - 调整止损价，确保在爆仓价上方/下方
  - 降低杠杆倍数，增加爆仓距离
  - 或者不设置止损（但风险较高）

#### 3. **数量格式错误或数量为0**
- **症状**：格式化后的数量为0或负数
- **原因**：
  - 仓位价值太小，除以价格后数量过小
  - 精度格式化导致四舍五入为0
- **检查方法**：查看日志中的"数量格式化"信息
- **解决方案**：
  - 增加仓位价值（position_size_usd）
  - 降低杠杆倍数（增加所需保证金，从而增加仓位价值）
  - 选择价格更低的币种

#### 4. **杠杆设置失败**
- **症状**：杠杆设置API调用失败
- **原因**：
  - 杠杆倍数超过交易所限制
  - 账户类型不支持该杠杆倍数
  - 杠杆设置API调用失败
- **检查方法**：查看杠杆设置日志
- **解决方案**：
  - 检查配置的杠杆上限
  - 降低杠杆倍数
  - 检查账户类型和权限

#### 5. **API权限不足**
- **症状**：API密钥没有交易权限
- **原因**：
  - API密钥只有读取权限，没有交易权限
  - API密钥被限制交易
- **检查方法**：检查API密钥权限设置
- **解决方案**：
  - 在OKX网站上检查API密钥权限
  - 确保API密钥有"交易"权限
  - 重新创建API密钥

#### 6. **订单参数错误**
- **症状**：instId、tdMode、side等参数错误
- **原因**：
  - 交易对格式错误（如BTCUSDT应为BTC-USDT-SWAP）
  - 仓位模式设置错误
  - 订单方向错误
- **检查方法**：查看日志中的"开仓请求参数"
- **解决方案**：
  - 检查交易对格式
  - 检查仓位模式（isolated/cross）
  - 检查订单方向（buy/sell）

#### 7. **系统维护或故障**
- **症状**：所有订单都失败
- **原因**：
  - OKX系统维护
  - OKX API故障
- **检查方法**：查看OKX官方公告
- **解决方案**：
  - 等待系统恢复
  - 联系OKX客服

### 诊断步骤

1. **查看详细日志**
   - 检查"开多仓失败"或"开空仓失败"的日志
   - 查看"请求详情"和"完整响应"
   - 查看"诊断建议"

2. **检查账户余额**
   - 查看"账户净值"和"可用余额"
   - 查看"所需保证金"
   - 对比可用余额和所需保证金

3. **检查数量格式化**
   - 查看"数量格式化"日志
   - 检查原始数量和格式化后的数量
   - 确认格式化后的数量不为0

4. **检查止损止盈价格**
   - 查看"当前价格"和"爆仓价"
   - 查看"止损价"
   - 确认止损价在爆仓价上方/下方

5. **检查杠杆设置**
   - 查看杠杆设置日志
   - 确认杠杆设置成功
   - 检查杠杆倍数是否合理

6. **检查API权限**
   - 登录OKX网站
   - 检查API密钥权限
   - 确认有交易权限

### 常见错误代码

| 错误代码 | 含义 | 解决方案 |
|---------|------|---------|
| 0 | 成功 | - |
| 1 | All operations failed | 参见上述诊断步骤 |
| 51008 | 订单失败 | 检查账户余额和订单参数 |
| 51000 | 参数错误 | 检查订单参数格式 |
| 51001 | 参数值为空 | 检查必填参数 |
| 51002 | 参数值错误 | 检查参数值范围 |
| 51003 | 参数类型错误 | 检查参数类型 |

### 代码改进（V1.65）

#### 1. 增强错误日志
- 记录完整的请求参数
- 记录完整的API响应
- 记录账户余额和所需保证金
- 记录当前价格和爆仓价
- 记录数量格式化结果

#### 2. 自动诊断
- 检查账户余额是否充足
- 检查止损价是否合理
- 检查数量格式化结果
- 根据错误代码提供诊断建议

#### 3. 预防措施
- 在提示词中强调止损价必须在爆仓价上方/下方
- 在提示词中强调账户余额要求
- 在代码中记录详细的诊断信息

### 示例日志

```
  ❌ 开多仓失败: 错误代码=1, 错误信息=All operations failed
  📋 请求详情: 币种=BTCUSDT, 数量=0.001 (原始=0.00123456), 杠杆=50, 止损=98000.0000, 止盈=105000.0000
  📋 完整响应: [{"ordId":"","instId":"BTC-USDT-SWAP","sCode":"1","sMsg":"All operations failed"}]
  💰 账户净值: 10.09 USDT
  💰 可用余额: 10.09 USDT
  💰 当前价格: 100000.0000, 爆仓价: 98000.0000, 止损价: 98000.0000
  ⚠️ 止损价低于或等于爆仓价！止损价必须在爆仓价上方
     做多时: 止损价必须 > 爆仓价 (98000.0000)
  💰 所需保证金: 1.00 USDT (仓位价值=50.00 / 杠杆=50)
  💡 诊断建议: 错误代码1 ('All operations failed') 通常表示:
     - 账户余额不足（检查可用余额和所需保证金）
     - 止损/止盈价格设置不合理（止损可能低于爆仓价）
     - 数量格式错误或数量为0（检查格式化后的数量）
     - 杠杆设置失败或杠杆倍数不符合要求（检查杠杆设置日志）
     - API权限不足（检查API密钥是否有交易权限）
     - 订单参数错误（检查instId、tdMode、side等参数）
```

### 解决方案

根据诊断结果，采取相应的解决方案：

1. **账户余额不足**：
   - 增加账户余额
   - 降低杠杆或减少仓位价值

2. **止损价不合理**：
   - 调整止损价，确保在爆仓价上方/下方
   - 降低杠杆，增加爆仓距离

3. **数量为0**：
   - 增加仓位价值
   - 降低杠杆
   - 选择价格更低的币种

4. **杠杆设置失败**：
   - 检查杠杆配置
   - 降低杠杆倍数

5. **API权限不足**：
   - 检查API密钥权限
   - 重新创建API密钥

---

## 参考资料

1. **OKX API文档**：
   - https://www.okx.com/docs-v5/zh/#rest-api-trade-place-order

2. **错误代码列表**：
   - https://www.okx.com/docs-v5/zh/#error-code

3. **常见问题**：
   - https://www.okx.com/zh-hans-eu/help/api-faq




