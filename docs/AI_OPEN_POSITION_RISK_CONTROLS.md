# AI开仓风险控制完整清单

## 📋 当前V1.65版本风险控制状态

### ✅ 代码层面的硬性验证（会阻止开仓）

#### 1. Action有效性验证
**位置**: `nofx/decision/engine.go:948-962`
```go
validActions := map[string]bool{
    "open_long": true, "open_short": true,
    "close_long": true, "close_short": true,
    // ...
}
```
- **风险控制点**: 只允许预定义的操作，防止非法操作
- **状态**: ✅ 已实现

#### 2. 杠杆倍数验证
**位置**: `nofx/decision/engine.go:977-979`
```go
if d.Leverage <= 0 || d.Leverage > maxLeverage {
    return fmt.Errorf("杠杆必须在1-%d之间（%s，当前配置上限%d倍）: %d", ...)
}
```
- **风险控制点**: 
  - 杠杆必须 > 0
  - 杠杆不能超过配置上限（BTC/ETH 和山寨币分别配置）
  - 防止过度杠杆导致爆仓
- **状态**: ✅ 已实现

#### 3. 防止仓位叠加验证
**位置**: `nofx/trader/auto_trader.go:794-802` (开多) / `850-862` (开空)
```go
// 检查是否已有同币种同方向持仓
positions, err := at.trader.GetPositions()
if err == nil {
    for _, pos := range positions {
        if pos["symbol"] == decision.Symbol && pos["side"] == "long" {
            return fmt.Errorf("❌ %s 已有多仓，拒绝开仓以防止仓位叠加超限", ...)
        }
    }
}
```
- **风险控制点**: 防止同一币种同一方向重复开仓，避免仓位叠加
- **状态**: ✅ 已实现

---

### ⚠️ 提示词层面的软性约束（由AI遵守，代码不验证）

#### 1. 风险回报比要求
**位置**: `nofx/decision/engine.go:337-343` (精简版) / `367-375` (完整版)
- **要求**: 风险回报比必须≥3:1（计算时考虑手续费0.20%）
- **计算公式**:
  - 做多：风险=(当前价-止损)/当前价，收益=(止盈-当前价-手续费影响)/当前价
  - 做空：风险=(止损-当前价)/当前价，收益=(当前价-止盈-手续费影响)/当前价
  - 手续费影响=(position_size_usd×0.002)/数量，数量=position_size_usd/当前价
- **状态**: ⚠️ 仅在提示词中说明（V1.63从代码验证移除）
- **风险**: 如果AI不遵守，可能导致低质量交易

#### 2. 数量精度要求
**位置**: `nofx/decision/engine.go:344-348` (精简版) / `377-383` (完整版)
- **要求**: 数量=position_size_usd/当前价，必须≥0.001（OKX精度要求）
- **说明**: 高价币种需增加position_size_usd或降低杠杆以确保数量≥0.001
- **状态**: ⚠️ 仅在提示词中说明（V1.63从代码验证移除）
- **风险**: 如果AI不遵守，可能导致交易失败（数量格式化后为0）

#### 3. 最多持仓限制
**位置**: `nofx/decision/engine.go:332` (精简版) / `353` (完整版)
- **要求**: 最多持仓5个币种
- **状态**: ⚠️ 仅在提示词中说明，代码中未硬性验证
- **风险**: 如果AI不遵守，可能同时持有过多仓位，增加风险

#### 4. 清算距离要求
**位置**: `nofx/decision/engine.go:327` (精简版) / `350` (完整版)
- **要求**: 清算距离>5%（放宽限制，允许更灵活的开仓）
- **状态**: ⚠️ 仅在提示词中说明，代码中未硬性验证
- **风险**: 如果AI不遵守，可能导致爆仓风险
- **更新**: V1.65版本从8%放宽到5%

---

### ❌ 已移除的风险控制（历史版本）

#### 1. 最大保证金比例限制
- **原要求**: 单笔交易最大保证金 = 账户净值 × 30%
- **移除版本**: V1.62
- **移除原因**: 让AI自由决策保证金大小
- **风险**: 可能导致单笔交易占用过多资金

#### 2. 风险回报比代码验证
- **原要求**: 风险回报比必须≥3:1（代码中硬性验证）
- **移除版本**: V1.63
- **移除原因**: 改为在提示词中指导AI
- **风险**: 依赖AI遵守提示词，如果AI不遵守可能导致低质量交易

#### 3. 数量精度代码验证
- **原要求**: 数量必须≥0.001（代码中硬性验证）
- **移除版本**: V1.63
- **移除原因**: 改为在提示词中指导AI
- **风险**: 依赖AI遵守提示词，如果AI不遵守可能导致交易失败

#### 4. 流动性过滤
- **原要求**: 持仓价值必须≥5M USD
- **移除版本**: V1.63
- **移除原因**: 让AI自由选择币种
- **风险**: 可能选择低流动性币种，增加滑点风险

#### 5. 保证金+手续费验证
- **原要求**: 保证金+手续费必须≤可用余额
- **移除版本**: V1.62
- **移除原因**: 手续费已计入风险回报比计算
- **风险**: 依赖交易所最终验证保证金是否足够

#### 6. 仓位价值验证
- **原要求**: 仓位价值必须 > 0
- **移除版本**: V1.64
- **移除原因**: 改为在提示词中指导AI，由交易所处理验证
- **风险**: 依赖AI遵守提示词和交易所验证

#### 7. 最小保证金验证
- **原要求**: 保证金必须≥0.5 USDT
- **移除版本**: V1.64
- **移除原因**: 改为在提示词中指导AI，由交易所处理验证
- **风险**: 依赖AI遵守提示词和交易所验证

#### 8. 最小仓位价值验证
- **原要求**: 仓位价值必须≥5 USDT（OKX要求）
- **移除版本**: V1.64
- **移除原因**: 改为在提示词中指导AI，由交易所处理验证
- **风险**: 依赖AI遵守提示词和交易所验证

#### 9. 止损止盈合理性验证
- **原要求**: 止损和止盈必须>0，且逻辑合理（做多时止损<止盈，做空时止损>止盈）
- **移除版本**: V1.64
- **移除原因**: 改为在提示词中指导AI
- **风险**: 依赖AI遵守提示词，如果AI不遵守可能导致设置错误

---

## 🔍 风险控制流程

### 开仓决策验证流程（V1.65）

```
1. AI生成决策
   ↓
2. extractDecisions() - 提取JSON决策
   ↓
3. validateDecisions() - 批量验证
   ↓
4. validateDecision() - 单个决策验证
   ├─ Action有效性 ✓ (代码验证)
   ├─ 杠杆倍数验证 ✓ (代码验证: 1-配置上限)
   ├─ 仓位价值验证 ⚠️ (提示词指导，代码不验证，V1.64移除)
   ├─ 最小保证金验证 ⚠️ (提示词指导，代码不验证，V1.64移除)
   ├─ 最小仓位价值验证 ⚠️ (提示词指导，代码不验证，V1.64移除)
   ├─ 止损止盈合理性验证 ⚠️ (提示词指导，代码不验证，V1.64移除)
   ├─ 风险回报比验证 ⚠️ (提示词指导，代码不验证，V1.63移除)
   ├─ 数量精度验证 ⚠️ (提示词指导，代码不验证，V1.63移除)
   └─ 爆仓价格计算 ⚠️ (提示词指导，代码不验证，V1.65新增)
   ↓
5. executeOpenLongWithRecord() - 执行开仓
   ├─ 防止仓位叠加验证 ✓ (代码验证)
   └─ 交易所最终验证（保证金、数量、名义价值等）
   ↓
6. 开仓成功
```

---

## ⚠️ 当前风险点分析

### 高风险点（代码不验证，依赖AI）

1. **风险回报比**: 
   - 如果AI不遵守≥3:1的要求，可能导致低质量交易
   - **建议**: 考虑恢复代码验证，或加强提示词

2. **数量精度**: 
   - 如果AI不遵守≥0.001的要求，可能导致交易失败
   - **建议**: 考虑恢复代码验证，或加强提示词

3. **清算距离**: 
   - 如果AI不遵守>8%的要求，可能导致爆仓风险
   - **建议**: 考虑添加代码验证

4. **最多持仓限制**: 
   - 如果AI不遵守5个币种的限制，可能同时持有过多仓位
   - **建议**: 考虑添加代码验证

### 中风险点（已移除的验证）

1. **最大保证金比例**: 
   - 已移除30%限制，AI可以自由决策
   - **风险**: 可能导致单笔交易占用过多资金
   - **建议**: 根据实际需求决定是否恢复

2. **流动性过滤**: 
   - 已移除5M USD限制，AI可以自由选择币种
   - **风险**: 可能选择低流动性币种，增加滑点风险
   - **建议**: 根据实际需求决定是否恢复

---

## 📊 风险控制参数汇总

### 代码硬性验证参数

| 参数 | 值 | 位置 | 说明 |
|------|-----|------|------|
| **最小保证金** | 0.5 USDT | `validateDecision` | 硬性验证 |
| **最小仓位价值** | 5.0 USDT | `validateDecision` | OKX交易所要求 |
| **杠杆倍数** | 1-配置上限 | `validateDecision` | BTC/ETH和山寨币分别配置 |
| **止损止盈** | 必须>0且合理 | `validateDecision` | 做多时止损<止盈，做空时止损>止盈 |

### 提示词软性约束参数

| 参数 | 要求 | 位置 | 说明 |
|------|------|------|------|
| **风险回报比** | ≥3:1 | `buildSystemPrompt` | 仅在提示词中说明 |
| **数量精度** | ≥0.001 | `buildSystemPrompt` | 仅在提示词中说明 |
| **最多持仓** | 5个币种 | `buildSystemPrompt` | 仅在提示词中说明 |
| **清算距离** | >5% | `buildSystemPrompt` | 仅在提示词中说明（V1.65从8%放宽到5%） |

---

## 💡 建议

### 短期建议（立即实施）

1. **恢复数量精度验证**: 
   - 数量精度验证是硬性要求，应该恢复代码验证
   - 避免因AI不遵守导致交易失败

2. **加强风险回报比提示词**: 
   - 如果保持提示词指导，需要加强提示词的说明
   - 明确告知AI不遵守的后果

### 中期建议（1-2周实施）

1. **添加清算距离验证**: 
   - 清算距离是重要的风险控制指标
   - 建议添加代码验证，确保清算距离>8%

2. **添加最多持仓验证**: 
   - 防止AI同时持有过多仓位
   - 建议添加代码验证，确保最多5个币种

### 长期建议（1个月+实施）

1. **恢复风险回报比验证**: 
   - 风险回报比是重要的交易质量指标
   - 建议恢复代码验证，确保≥3:1

2. **添加最大保证金比例限制**: 
   - 根据实际需求决定是否恢复30%限制
   - 或调整为其他合适的比例

---

**文档版本**: V1.0  
**最后更新**: 2025-11-08  
**对应代码版本**: V1.63


